<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="myjourney.Myjourney"> 
	<!-- AutoList Query Start -->
	<insert id="Startinsertjourney">
		insert into myjourney (jnum,id,xpos,ypos,cate,ref,turn,jdate)
		values(myj_seq.nextval,#{id},#{xpos},#{ypos},#{cate},#{ref},#{turn},#{jdate})
	</insert>
	<insert id="insertjourney">
		insert into myjourney (jnum,id,xpos,ypos,cate,ref,turn,jdate)
		values(#{jnum},#{id},#{xpos},#{ypos},#{cate},#{ref},#{turn},#{jdate})
	</insert>

	<select id="myjSelect" resultType="myjourney.model.MyJourneyBean" >
	SELECT
    m.jnum, m.id, m.xpos, m.ypos, m.cate, m.ref, m.turn, m.jdate,
    COALESCE(s.name, r.name, h.name, c.name) AS name,
    COALESCE(s.address, r.address, h.address, c.address) AS address,
    COALESCE(s.image, r.image, h.image, c.image) AS image,
    COALESCE(s.image2, r.image2, h.image2, c.image2) AS image2,
    COALESCE(s.image3, r.image3, h.image3, c.image3) AS image3,
    COALESCE(s.image4, r.image4, h.image4, c.image4) AS image4,
    COALESCE(s.image5, r.image5, h.image5, c.image5) AS image5
	FROM
    myjourney m
	LEFT JOIN spot s ON m.ref = s.snum AND m.cate = 'spot'
	LEFT JOIN rest r ON m.ref = r.rnum AND m.cate = 'restaurant'
	LEFT JOIN hotel h ON m.ref = h.hnum AND m.cate = 'hotel'
	LEFT JOIN cafe c ON m.ref = c.cnum AND m.cate = 'cafe'
	WHERE
    m.id = #{id} and m.jdate = #{jdate} 
   order by m.turn 
		</select>
	<select id="myjDaySelect" resultType="myjourney.model.MyJourneyBean" >
	SELECT DISTINCT jdate FROM myjourney WHERE id = #{id} order by jdate 
	</select>

	<select id="getAllMyJourneyByJdate" resultType="myjourney.model.MyJourneyBean">
		SELECT
		m.jnum AS jnum, m.xpos AS xpos, m.ypos AS ypos, m.cate AS cate, m.ref AS ref, m.jdate AS jdate,
		COALESCE(s.name, r.name, h.name, c.name) AS name,
		COALESCE(s.address, r.address, h.address, c.address) AS address
		FROM
		myjourney m
		LEFT JOIN spot s ON m.ref = s.snum AND m.cate = 'spot'
		LEFT JOIN rest r ON m.ref = r.rnum AND m.cate = 'restaurant'
		LEFT JOIN hotel h ON m.ref = h.hnum AND m.cate = 'hotel'
		LEFT JOIN cafe c ON m.ref = c.cnum AND m.cate = 'cafe'
		WHERE
		m.jdate = #{jdate} and turn = 0
		order by m.jnum
	</select>
	
	<insert id="insertMyJourney">
		insert into myjourney(jnum,id,xpos,ypos,cate,ref,turn,jdate)
		<if test="cate=='cafe'">
		values(myj_seq.nextval,#{id},#{cb.xpos},#{cb.ypos},#{cate},#{cb.cnum},'0',#{jdate})
		</if>
		<if test="cate=='hotel'">
		values(myj_seq.nextval,#{id},#{hb.xpos},#{hb.ypos},#{cate},#{hb.hnum},'0',#{jdate})
		</if>
		<if test="cate=='restaurant'">
		values(myj_seq.nextval,#{id},#{rb.xpos},#{rb.ypos},#{cate},#{rb.rnum},'0',#{jdate})
		</if>
		<if test="cate=='spot'">
		values(myj_seq.nextval,#{id},#{sb.xpos},#{sb.ypos},#{cate},#{sb.snum},'0',#{jdate})
		</if>
	</insert>
	
	<delete id="deleteMyjourney">
		delete from myjourney
		where jnum=#{jnum}
	</delete>
	
	<update id="saveMyJourney">
		update myjourney set turn = turn+1
		where id=#{id} and turn=0
	</update>
	
	<select id="searchTurnMore" resultType="int">
		select count(*) from myjourney
		where id=#{id} and turn>0
	</select>
	
	<update id="updateMJList">
		update myjourney set turn = turn+1
		where id=#{id} and turn>0
	</update>
	<!-- ManualList Query End -->
</mapper>